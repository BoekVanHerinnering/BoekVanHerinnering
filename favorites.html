<!DOCTYPE html>
<html lang="af">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gunsteling Verse Met Kleure</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f3f3f3;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
  }
  .page {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 400px;
    margin-top: 40px;
    max-height: 90vh;
    overflow-y: auto;
  }
  h2 {
    text-align: center;
    margin-bottom: 20px;
  }
  .buttons-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .favorite-item {
    background: #f9f9f9;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 6px;
    position: relative;
    cursor: default;
  }
  .favorite-item strong {
    display: block;
    margin-bottom: 5px;
  }
  .delete-btn {
    position: absolute;
    bottom: 8px;
    right: 5px;
    background: transparent;
    border: none;
    color: #ff0000;
    font-size: 18px;
    cursor: pointer;
  }
  .delete-btn:hover {
    color: #a7001f;
  }
  .favorites-footer {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }
  .favorites-footer .button {
    flex: 1;
    padding: 10px;
    background-color: #000;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  .favorites-footer .button:hover {
    background-color: #838383;
  }
  .clear-btn {
    background-color: #dc3545;
  }
  .clear-btn:hover {
    background-color: #b02a37;
  }
  .favorite-buttons button {
    margin-right: 5px;
    padding: 4px 8px;
    font-size: 14px;
    border: none;
    background: #000;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  .favorite-buttons button:hover {
    background: #707070;
  }

  /* Color palette popup */
  #colorPalette {
    position: fixed;
    display: none;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
  }
  #colorPalette button {
    width: 24px;
    height: 24px;
    border: none;
    margin: 3px;
    border-radius: 50%;
    cursor: pointer;
  }

  /* Marker button colored */
  .highlight-btn {
    position: relative;
  }

  .flash-highlight {
  animation: flash 1s ease-in-out 3;
}

@keyframes flash {
  0%   { background-color: #ffffcc; }
  50%  { background-color: #ffeb3b; }
  100% { background-color: transparent; }
}


  .highlight-btn.color-yellow { background-color: #fff176; color: black; }
  .highlight-btn.color-green { background-color: #a5d6a7; color: black; }
  .highlight-btn.color-pink  { background-color: #f48fb1; color: black; }
  .highlight-btn.color-blue  { background-color: #81d4fa; color: black; }
  .highlight-btn.color-none  { background-color: #000; color: white; }
</style>
</head>
<body>
<div id="favoritesContainer" class="page">
  <h2>‚≠ê Jou Gunsteling Verse</h2>
  <div id="favoritesList" class="buttons-container">
    <!-- Favorite verses go here -->
  </div>

  <div class="favorites-footer">
    <button class="button" onclick="window.location.href='index.html'">üè† Home</button>
    <button class="button clear-btn" onclick="clearAllFavorites()">üóëÔ∏è Clear All</button>
  </div>
</div>

<!-- Color palette popup -->
<div id="colorPalette">
  <button data-color="yellow" style="background:#fff176;" title="Geel"></button>
  <button data-color="green" style="background:#a5d6a7;" title="Groen"></button>
  <button data-color="pink"  style="background:#f48fb1;" title="Pienk"></button>
  <button data-color="blue"  style="background:#81d4fa;" title="Blou"></button>
  <button data-color="none"  style="background:#000; color:white;" title="Verwyder merk">X</button>
</div>

<script>
  const favoritesList = document.getElementById("favoritesList");
  const colorPalette = document.getElementById("colorPalette");

  // Load favorites & render
  function renderFavorites() {
    favoritesList.innerHTML = "";
    let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
    if (favorites.length === 0) {
      favoritesList.innerHTML = "<p>Geen gunsteling verse gestoor nie.</p>";
      return;
    }

    favorites.forEach(fav => {
      const div = document.createElement("div");
      div.className = "favorite-item";
      div.id = fav.id;

      // If highlight HTML exists, use that, else plain text
      const verseHTML = fav.highlightedHTML || escapeHtml(fav.text);

      // Determine button color class from saved highlightColor, else none
      const btnColorClass = fav.highlightColor ? `color-${fav.highlightColor}` : "color-none";

      div.innerHTML = `
        <strong>${fav.title}</strong>
        <span class="highlightable-text">${verseHTML}</span>
        ${fav.note ? `<div class="note-text">üìù ${fav.note}</div>` : ""}
        <div class="favorite-buttons">
          <button class="open-btn">üìñ Open</button>
          <button class="highlight-btn ${btnColorClass}" title="Markeer & verander kleur">üñçÔ∏è</button>
          <button class="note-btn">üìù</button>
          <button class="delete-btn">üóëÔ∏è</button>
        </div>
      `;

      // Add event listeners
      // Open scroll
      div.querySelector(".open-btn").addEventListener("click", e => {
        e.stopPropagation();
        window.location.href = "index.html?scrollTo=" + encodeURIComponent(fav.id);
      });

      // Delete favorite
      div.querySelector(".delete-btn").addEventListener("click", e => {
        e.stopPropagation();
        deleteFavorite(fav.id);
      });

      // Add or edit note
      div.querySelector(".note-btn").addEventListener("click", e => {
        e.stopPropagation();
        const newNote = prompt("Skryf 'n nota vir hierdie vers:", fav.note || "");
        if (newNote !== null) {
          fav.note = newNote.trim();
          saveFavorite(fav);
          renderFavorites();
        }
      });

      // Highlight button click
      div.querySelector(".highlight-btn").addEventListener("click", e => {
        e.stopPropagation();
        openColorPalette(e.currentTarget, div, fav);
      });

      favoritesList.appendChild(div);
    });
  }

  // Escape HTML special chars to prevent XSS if needed
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }

  // Save favorite (update or add)
  function saveFavorite(fav) {
    let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
    const idx = favorites.findIndex(f => f.id === fav.id);
    if (idx !== -1) favorites[idx] = fav;
    else favorites.push(fav);
    localStorage.setItem("favorites", JSON.stringify(favorites));
  }

  // Delete favorite
  function deleteFavorite(id) {
    let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
    favorites = favorites.filter(f => f.id !== id);
    localStorage.setItem("favorites", JSON.stringify(favorites));
    renderFavorites();
  }

  // Clear all favorites
  function clearAllFavorites() {
    if(confirm("Is jy seker jy wil alle gunstelinge verwyder?")) {
      localStorage.removeItem("favorites");
      renderFavorites();
    }
  }

  // Open color palette near button
  function openColorPalette(button, verseDiv, fav) {
    // Save context so color picker knows which verse to edit
    colorPalette.style.display = "block";

    // Position popup near button
    const rect = button.getBoundingClientRect();
    colorPalette.style.top = (rect.bottom + window.scrollY + 5) + "px";
    colorPalette.style.left = (rect.left + window.scrollX) + "px";

    // Save current context in dataset for color buttons
    colorPalette.dataset.verseId = fav.id;
    colorPalette.dataset.verseDivId = verseDiv.id;

    // Setup color buttons handlers
    [...colorPalette.querySelectorAll("button")].forEach(btn => {
      btn.onclick = () => {
        const color = btn.dataset.color;

        if (color === "none") {
          // Remove highlights and highlightColor
          fav.highlightColor = null;
          fav.highlightedHTML = escapeHtml(fav.text);
        } else {
          // Highlight selected text or entire verse if no selection
          highlightText(verseDiv, fav, color);
        }

        // Save favorite and rerender list
        saveFavorite(fav);
        renderFavorites();

        // Hide palette
        colorPalette.style.display = "none";
      };
    });
  }

  // Function to highlight selected text inside verseDiv with chosen color
  function highlightText(verseDiv, fav, color) {
    const textEl = verseDiv.querySelector(".highlightable-text");

    const selection = window.getSelection();
    if (!selection.rangeCount) {
      // No text selected - highlight entire verse text as fallback
      fav.highlightColor = color;
      fav.highlightedHTML = `<mark style="background-color:${getColorCode(color)};">${escapeHtml(fav.text)}</mark>`;
      return;
    }
    const range = selection.getRangeAt(0);

    // Check selection inside textEl
    if (!textEl.contains(range.commonAncestorContainer)) {
      alert("Kies asseblief teks binne hierdie vers.");
      return;
    }

    // Wrap selected text in mark with color
    const selectedText = selection.toString();
    if (!selectedText.trim()) {
      alert("Maak asseblief 'n tekskeuse.");
      return;
    }

    // Create a temporary element to hold selected HTML
    const span = document.createElement("mark");
    span.style.backgroundColor = getColorCode(color);
    span.textContent = selectedText;

    // Replace selected contents with colored mark
    range.deleteContents();
    range.insertNode(span);

    // Save updated HTML
    fav.highlightColor = color;
    fav.highlightedHTML = textEl.innerHTML;

    // Clear selection
    selection.removeAllRanges();
  }

  // Map color names to actual hex codes
  function getColorCode(colorName) {
    switch(colorName) {
      case "yellow": return "#fff176";
      case "green":  return "#a5d6a7";
      case "pink":   return "#f48fb1";
      case "blue":   return "#81d4fa";
      default:      return "transparent";
    }
  }

  // Close color palette when clicking outside
  document.addEventListener("click", (e) => {
    if (!colorPalette.contains(e.target) && !e.target.classList.contains("highlight-btn")) {
      colorPalette.style.display = "none";
    }
  });

  // Initial render
  renderFavorites();

  
  window.addEventListener("DOMContentLoaded", () => {
  const newIdsRaw = sessionStorage.getItem("newFavoriteIds");
  if (!newIdsRaw) return;

  try {
    const newIds = JSON.parse(newIdsRaw);
    if (!Array.isArray(newIds)) return;

    newIds.forEach((id, index) => {
      const target = document.getElementById(id);
      if (target) {
        target.classList.add("flash-highlight");

        // Scroll only to the first newly added favorite
        if (index === 0) {
          target.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        setTimeout(() => {
          target.classList.remove("flash-highlight");
        }, 3000);
      }
    });
  } catch (e) {
    console.warn("Could not parse newFavoriteIds from sessionStorage");
  }

  sessionStorage.removeItem("newFavoriteIds");
});




</script>
</body>
</html>
